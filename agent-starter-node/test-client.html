<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveKit Agent Test Client</title>
    <script src="https://unpkg.com/livekit-client@latest/dist/livekit-client.umd.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        button.stop {
            background: #f44336;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
        }
        .transcript {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
        }
        .transcript-item {
            margin: 5px 0;
            padding: 5px;
        }
        .user {
            color: #2196F3;
        }
        .agent {
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¤ LiveKit Agent Test Client</h1>
        
        <div class="status" id="status">Disconnected</div>
        
        <div>
            <button id="connectBtn" onclick="connect()">Connect</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled class="stop">Disconnect</button>
        </div>
        
        <div class="transcript" id="transcript">
            <div class="transcript-item">Waiting to connect...</div>
        </div>
    </div>

    <script>
        const { Room, RoomEvent, Track, RemoteTrackPublication } = LiveKit;
        
        let room = null;
        let localAudioTrack = null;
        
        // Update these with your LiveKit credentials
        const LIVEKIT_URL = 'wss://verlyai-fjmbd34k.livekit.cloud';
        const API_KEY = 'APIL3GZDeGsa2Hq';
        const API_SECRET = '65qDaVl2OdXWdGKWYPCntWT0N9L3l8rzn0r8cjN9EgM';
        
        async function getToken(roomName, participantName) {
            // In production, get token from your backend
            // For testing, we'll generate a simple token
            const response = await fetch(`https://agents-playground.livekit.io/api/token`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    url: LIVEKIT_URL,
                    apiKey: API_KEY,
                    apiSecret: API_SECRET,
                    room: roomName,
                    identity: participantName
                })
            });
            return await response.text();
        }
        
        async function connect() {
            try {
                updateStatus('Connecting...');
                
                const roomName = `test-room-${Date.now()}`;
                const participantName = `user-${Math.random().toString(36).substr(2, 9)}`;
                
                // Get token (using playground API for simplicity)
                const token = await getToken(roomName, participantName);
                
                room = new Room();
                
                // Set up event listeners
                room.on(RoomEvent.Connected, () => {
                    updateStatus('Connected! Agent should join shortly...');
                    addTranscript('system', 'Connected to room: ' + roomName);
                });
                
                room.on(RoomEvent.Disconnected, () => {
                    updateStatus('Disconnected');
                    addTranscript('system', 'Disconnected from room');
                });
                
                room.on(RoomEvent.TrackSubscribed, (track, publication, participant) => {
                    if (track.kind === Track.Kind.Audio) {
                        const audioElement = new Audio();
                        audioElement.srcObject = new MediaStream([track.mediaStreamTrack]);
                        audioElement.play();
                        addTranscript('system', `Agent audio track subscribed`);
                    }
                });
                
                room.on(RoomEvent.DataReceived, (payload, participant) => {
                    if (payload.topic === 'transcription') {
                        const text = new TextDecoder().decode(payload);
                        const data = JSON.parse(text);
                        if (data.text) {
                            addTranscript(data.is_final ? 'agent' : 'agent-pending', data.text);
                        }
                    }
                });
                
                // Connect to room
                await room.connect(LIVEKIT_URL, token);
                
                // Enable microphone
                localAudioTrack = await room.localParticipant.setMicrophoneEnabled(true);
                addTranscript('system', 'Microphone enabled');
                
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                
            } catch (error) {
                console.error('Connection error:', error);
                updateStatus('Error: ' + error.message);
                addTranscript('system', 'Error: ' + error.message);
            }
        }
        
        async function disconnect() {
            if (room) {
                await room.disconnect();
                room = null;
            }
            if (localAudioTrack) {
                localAudioTrack.stop();
                localAudioTrack = null;
            }
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            updateStatus('Disconnected');
        }
        
        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }
        
        function addTranscript(speaker, text) {
            const transcript = document.getElementById('transcript');
            const item = document.createElement('div');
            item.className = `transcript-item ${speaker}`;
            item.textContent = `[${speaker === 'user' ? 'You' : speaker === 'agent' ? 'Agent' : 'System'}] ${text}`;
            transcript.appendChild(item);
            transcript.scrollTop = transcript.scrollHeight;
        }
    </script>
</body>
</html>

