<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveKit Agent - Voice Assistant</title>
    <script>
        // Load LiveKit script dynamically to ensure it loads before our code runs
        (function() {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/livekit-client@2.16.0/dist/livekit-client.umd.js';
            script.async = false; // Load synchronously
            script.onload = function() {
                console.log('LiveKit script loaded');
                window.livekitScriptLoaded = true;
            };
            script.onerror = function() {
                console.error('Failed to load LiveKit script');
                window.livekitScriptError = true;
            };
            document.head.appendChild(script);
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        .status {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .status.disconnected {
            background: #fee;
            color: #c33;
        }

        .status.connecting {
            background: #ffe;
            color: #cc6;
        }

        .status.connected {
            background: #efe;
            color: #3c3;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        button {
            flex: 1;
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button.connect {
            background: #4CAF50;
            color: white;
        }

        button.connect:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        button.disconnect {
            background: #f44336;
            color: white;
        }

        button.disconnect:hover:not(:disabled) {
            background: #da190b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .transcript-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .transcript-item {
            margin: 10px 0;
            padding: 12px 15px;
            border-radius: 8px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .transcript-item.system {
            background: #e3f2fd;
            color: #1976d2;
            font-style: italic;
        }

        .transcript-item.user {
            background: #e1f5fe;
            color: #0277bd;
            text-align: right;
        }

        .transcript-item.agent {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .transcript-item.agent-pending {
            background: #fff9c4;
            color: #f57f17;
            opacity: 0.7;
        }

        .transcript-item strong {
            display: block;
            margin-bottom: 5px;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 0.9em;
            color: #856404;
        }

        .info code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Voice AI Assistant</h1>
        <p class="subtitle">Connect to your LiveKit agent and start talking</p>
        
        <div class="status disconnected" id="status">Disconnected</div>
        
        <div class="controls">
            <button class="connect" id="connectBtn">Connect</button>
            <button class="disconnect" id="disconnectBtn" disabled>Disconnect</button>
        </div>
        
        <div class="transcript-container" id="transcript">
            <div class="transcript-item system">
                <strong>System</strong>
                Ready to connect. Click "Connect" to start.
            </div>
        </div>

        <div class="info">
            <strong>‚ÑπÔ∏è Instructions:</strong><br>
            ‚Ä¢ Make sure backend is running: <code>pnpm run server</code> (Terminal 1)<br>
            ‚Ä¢ Make sure frontend is running: <code>pnpm run frontend</code> (Terminal 2)<br>
            ‚Ä¢ Click Connect and allow microphone access<br>
            ‚Ä¢ The agent will greet you automatically<br>
            ‚Ä¢ Start speaking - the agent will respond!
        </div>
    </div>

    <script>
        // Wait for LiveKit to load and DOM to be ready
        let initAttempts = 0;
        const MAX_ATTEMPTS = 50; // 5 seconds max wait
        
        function initApp() {
            initAttempts++;
            
            // Check if script had an error
            if (window.livekitScriptError) {
                console.error('LiveKit script failed to load');
                document.getElementById('status').textContent = 'Error: Failed to load LiveKit. Check internet connection.';
                document.getElementById('status').className = 'status disconnected';
                return;
            }
            
            // Check if LiveKit is loaded (try multiple ways)
            const livekitAvailable = (typeof LiveKit !== 'undefined' && LiveKit.Room) || 
                                   (typeof window !== 'undefined' && window.LiveKit && window.LiveKit.Room);
            
            if (!livekitAvailable) {
                if (initAttempts < MAX_ATTEMPTS) {
                    if (initAttempts % 10 === 0) { // Log every second
                        console.log(`Waiting for LiveKit to load... (attempt ${initAttempts}/${MAX_ATTEMPTS})`);
                    }
                    setTimeout(initApp, 100);
                    return;
                } else {
                    console.error('LiveKit failed to load after 5 seconds.');
                    console.log('LiveKit type:', typeof LiveKit);
                    console.log('window.LiveKit type:', typeof window.LiveKit);
                    console.log('Script loaded flag:', window.livekitScriptLoaded);
                    document.getElementById('status').textContent = 'Error: LiveKit failed to load. Please refresh.';
                    document.getElementById('status').className = 'status disconnected';
                    return;
                }
            }
            
            console.log('‚úÖ LiveKit loaded, initializing app...');
            
            // Get LiveKit from global scope (UMD bundle exposes it globally)
            const LiveKitLib = typeof LiveKit !== 'undefined' ? LiveKit : (typeof window !== 'undefined' ? window.LiveKit : null);
            
            if (!LiveKitLib || !LiveKitLib.Room) {
                console.error('LiveKit object not found or incomplete');
                if (typeof window !== 'undefined') {
                    console.log('Checking window object...', typeof window.LiveKit);
                    console.log('Available keys:', Object.keys(window).slice(0, 20));
                }
                return;
            }
            
            console.log('‚úÖ LiveKit object found and ready');
            const { Room, RoomEvent, Track } = LiveKitLib;
            
            let room = null;
            let localAudioTrack = null;
            const TOKEN_SERVER_URL = 'http://localhost:3001';
            
            async function connect() {
                try {
                    updateStatus('Connecting...', 'connecting');
                    addTranscript('system', 'Connecting to LiveKit...');
                    
                    const roomName = `room-${Date.now()}`;
                    const participantName = `user-${Math.random().toString(36).substr(2, 9)}`;
                    
                    // Get token from token server
                    const response = await fetch(`${TOKEN_SERVER_URL}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomName, participantName })
                });
                
                if (!response.ok) {
                    throw new Error(`Token server error: ${response.statusText}`);
                }
                
                const { token, url } = await response.json();
                addTranscript('system', `Got token for room: ${roomName}`);
                
                // Create room instance
                room = new Room({
                    adaptiveStream: true,
                    dynacast: true,
                });
                
                // Set up event listeners
                room.on(RoomEvent.Connected, () => {
                    updateStatus('Connected! Waiting for agent...', 'connected');
                    addTranscript('system', 'Connected to room. Agent should join shortly...');
                });
                
                room.on(RoomEvent.Disconnected, (reason) => {
                    updateStatus('Disconnected', 'disconnected');
                    addTranscript('system', `Disconnected: ${reason}`);
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                });
                
                room.on(RoomEvent.ParticipantConnected, (participant) => {
                    if (participant.identity.startsWith('agent') || participant.name?.includes('agent')) {
                        addTranscript('system', 'ü§ñ Agent joined the room!');
                    } else {
                        addTranscript('system', `Participant ${participant.identity} joined`);
                    }
                });
                
                room.on(RoomEvent.TrackSubscribed, (track, publication, participant) => {
                    if (track.kind === Track.Kind.Audio) {
                        const audioElement = new Audio();
                        audioElement.srcObject = new MediaStream([track.mediaStreamTrack]);
                        audioElement.play().catch(err => {
                            console.error('Error playing audio:', err);
                        });
                        
                        const isAgent = participant.identity.startsWith('agent') || participant.name?.includes('agent');
                        addTranscript('system', `${isAgent ? 'ü§ñ Agent' : 'Participant'} audio track subscribed`);
                    }
                });
                
                room.on(RoomEvent.DataReceived, (payload, participant) => {
                    if (payload.topic === 'transcription') {
                        try {
                            const text = new TextDecoder().decode(payload);
                            const data = JSON.parse(text);
                            if (data.text) {
                                const isAgent = participant.identity.startsWith('agent') || participant.name?.includes('agent');
                                const speaker = isAgent ? 'agent' : 'user';
                                addTranscript(data.is_final ? speaker : `${speaker}-pending`, data.text);
                            }
                        } catch (e) {
                            console.error('Error parsing transcription:', e);
                        }
                    }
                });
                
                // Connect to room
                await room.connect(url, token);
                
                // Enable microphone
                try {
                    localAudioTrack = await room.localParticipant.setMicrophoneEnabled(true);
                    addTranscript('system', '‚úÖ Microphone enabled - you can start speaking!');
                } catch (err) {
                    addTranscript('system', '‚ö†Ô∏è Microphone access denied. Please allow microphone access.');
                    console.error('Microphone error:', err);
                }
                
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                
            } catch (error) {
                console.error('Connection error:', error);
                updateStatus('Connection Error', 'disconnected');
                addTranscript('system', `‚ùå Error: ${error.message}`);
                
                if (error.message.includes('token server') || error.message.includes('fetch')) {
                    addTranscript('system', 'üí° Make sure backend is running: pnpm run server');
                }
            }
        }
        
        async function disconnect() {
            if (room) {
                await room.disconnect();
                room = null;
            }
            if (localAudioTrack) {
                localAudioTrack.stop();
                localAudioTrack = null;
            }
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            updateStatus('Disconnected', 'disconnected');
            addTranscript('system', 'Disconnected from room');
        }
        
        function updateStatus(text, className) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = text;
            statusEl.className = `status ${className}`;
        }
        
        function addTranscript(speaker, text) {
            const transcript = document.getElementById('transcript');
            const item = document.createElement('div');
            item.className = `transcript-item ${speaker}`;
            
            const speakerName = speaker === 'user' ? 'You' : 
                               speaker === 'agent' ? 'Agent' : 
                               speaker === 'agent-pending' ? 'Agent (typing...)' : 
                               'System';
            
            item.innerHTML = `<strong>${speakerName}</strong>${text}`;
            transcript.appendChild(item);
            transcript.scrollTop = transcript.scrollHeight;
        }
        
        // Attach event listeners to buttons
        document.getElementById('connectBtn').addEventListener('click', connect);
        document.getElementById('disconnectBtn').addEventListener('click', disconnect);
        }
        
        // Initialize when both DOM and LiveKit are ready
        function startApp() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initApp);
            } else {
                initApp();
            }
        }
        
        // Start initialization
        startApp();
    </script>
</body>
</html>

